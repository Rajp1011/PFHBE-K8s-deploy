apiVersion: batch/v1
kind: CronJob
metadata:
  name: ge-nightly-restart
  namespace: ge-dev
spec:
  # 0 2 * * * = 2:00 AM every day
  schedule: "0 2 * * *" 
  timezone: "America/Toronto" 
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        spec:
          serviceAccountName: restart-sa
          restartPolicy: Never
          containers:
          - name: kubectl-container
            image: bitnami/kubectl:latest
            command:
              - /bin/sh
              - -c
              - |
                set -e
                echo "--- Starting Nightly Restart ---"
                # Restart ge-service-1
                kubectl rollout restart deployment/ge-service-1 -n ge-dev
                kubectl rollout status deployment/ge-service-1 -n ge-dev --timeout=200s

                # Restart ge-service-2
                kubectl rollout restart deployment/ge-service-2 -n ge-dev
                kubectl rollout status deployment/ge-service-2 -n ge-dev --timeout=200s

                # Restart ge-service-3
                kubectl rollout restart deployment/ge-service-3 -n ge-dev
                kubectl rollout status deployment/ge-service-3 -n ge-dev --timeout=200s

                # Restart ge-service-4
                kubectl rollout restart deployment/ge-service-4 -n ge-dev
                kubectl rollout status deployment/ge-service-4 -n ge-dev --timeout=200s

                # Restart ge-service-5
                kubectl rollout restart deployment/ge-service-5 -n ge-dev
                kubectl rollout status deployment/ge-service-5 -n ge-dev --timeout=200s

                # Restart ge-web
                kubectl rollout restart deployment/ge-web-deployment -n ge-dev
                kubectl rollout status deployment/ge-web-deployment -n ge-dev --timeout=200s

                kubectl get pods -n ge-dev
                echo "All rollouts completed successfully at $(date)"
          