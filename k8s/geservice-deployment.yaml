# -----------------------------------------------------------
# GE Service: Deployments Only (1-5)
# -----------------------------------------------------------

# -------- GEService 1 --------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ge-service-1
  namespace: ge-dev
  labels:
    app: ge-service
    shard: "1"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ge-service
      shard: "1"
  template:
    metadata:
      labels:
        app: ge-service
        shard: "1"
    spec:
      nodeSelector:          
        agentpool: geserver  
      imagePullSecrets:
      - name: ghcr-pull-secret
      initContainers:
      - name: wait-for-config
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for /mnt to be ready..."
            while [ -z "$(ls -A /mnt 2>/dev/null)" ]; do
              sleep 2
            done
            echo "Config found. Starting service."
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /mnt
      containers:
      - name: ge-service-container
        image: ghcr.io/rajp1011/pfhbe/geservice:v3.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: "150m"
            memory: "256Mi"
          # limits:
          #   cpu: "250m"
          #   memory: "512Mi"
        env:
        - name: COMPlus_ThreadPool_ForceMinWorkerThreads
          value: "100"
        - name: COMPlus_gcServer
          value: "1"
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: sentry-secrets
              key: SENTRY_DSN
        - name: SENTRY_ENVIRONMENT
          value: "development"
        - name: SENTRY_RELEASE
          value: "pfh-kubernetes@v3.0.0"
        - name: SENTRY_SERVER_NAME
          value: "ge-service-1"

        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: REDIS_HOST_OVERRIDE
          value: "redis:6379"

        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 15
          failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 15
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /app/Internal
          readOnly: true
      volumes:
      - name: ge-service-config-volume
        persistentVolumeClaim:
          claimName: ge-pvc
---
# -------- GEService 2 --------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ge-service-2
  namespace: ge-dev
  labels:
    app: ge-service
    shard: "2"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ge-service
      shard: "2"
  template:
    metadata:
      labels:
        app: ge-service
        shard: "2"
    spec:
      nodeSelector:          
        agentpool: geserver  
      imagePullSecrets:
      - name: ghcr-pull-secret
      initContainers:
      - name: wait-for-config
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for /mnt to be ready..."
            while [ -z "$(ls -A /mnt 2>/dev/null)" ]; do
              sleep 2
            done
            echo "Config found. Starting service."
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /mnt
      containers:
      - name: ge-service-container
        image: ghcr.io/rajp1011/pfhbe/geservice:v3.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: "150m"
            memory: "256Mi"
          # limits:
          #   cpu: "1000m"
          #   memory: "1024Mi"
        env:
        - name: COMPlus_ThreadPool_ForceMinWorkerThreads
          value: "100"
        - name: COMPlus_gcServer
          value: "1"
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: sentry-secrets
              key: SENTRY_DSN
        - name: SENTRY_ENVIRONMENT
          value: "development"
        - name: SENTRY_RELEASE
          value: "pfh-kubernetes@v3.0.0"
        - name: SENTRY_SERVER_NAME
          value: "ge-service-2"

        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: REDIS_HOST_OVERRIDE
          value: "redis:6379"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          # timeoutSeconds: 15
          # failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 2
          periodSeconds: 3
          successThreshold: 1
          # timeoutSeconds: 10
          # failureThreshold: 10
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /app/Internal
          readOnly: true
      volumes:
      - name: ge-service-config-volume
        persistentVolumeClaim:
          claimName: ge-pvc
---
# -------- GEService 3 --------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ge-service-3
  namespace: ge-dev
  labels:
    app: ge-service
    shard: "3"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ge-service
      shard: "3"
  template:
    metadata:
      labels:
        app: ge-service
        shard: "3"
    spec:
      nodeSelector:          
        agentpool: geserver  
      imagePullSecrets:
      - name: ghcr-pull-secret
      initContainers:
      - name: wait-for-config
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for /mnt to be ready..."
            while [ -z "$(ls -A /mnt 2>/dev/null)" ]; do
              sleep 2
            done
            echo "Config found. Starting service."
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /mnt
      containers:
      - name: ge-service-container
        image: ghcr.io/rajp1011/pfhbe/geservice:v3.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: "150m"
            memory: "256Mi"
          # limits:
          #   cpu: "250m"
          #   memory: "512Mi"
        env:
        - name: COMPlus_ThreadPool_ForceMinWorkerThreads
          value: "100"
        - name: COMPlus_gcServer
          value: "1"
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: sentry-secrets
              key: SENTRY_DSN
        - name: SENTRY_ENVIRONMENT
          value: "development"
        - name: SENTRY_RELEASE
          value: "pfh-kubernetes@v3.0.0"
        - name: SENTRY_SERVER_NAME
          value: "ge-service-3"

        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: REDIS_HOST_OVERRIDE
          value: "redis:6379"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 15
          failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 15
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /app/Internal
          readOnly: true
      volumes:
      - name: ge-service-config-volume
        persistentVolumeClaim:
          claimName: ge-pvc
---
# -------- GEService 4 --------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ge-service-4
  namespace: ge-dev
  labels:
    app: ge-service
    shard: "4"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ge-service
      shard: "4"
  template:
    metadata:
      labels:
        app: ge-service
        shard: "4"
    spec:
      nodeSelector:          
        agentpool: geserver  
      imagePullSecrets:
      - name: ghcr-pull-secret
      initContainers:
      - name: wait-for-config
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for /mnt to be ready..."
            while [ -z "$(ls -A /mnt 2>/dev/null)" ]; do
              sleep 2
            done
            echo "Config found. Starting service."
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /mnt
      containers:
      - name: ge-service-container
        image: ghcr.io/rajp1011/pfhbe/geservice:v3.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: "150m"
            memory: "256Mi"
          # limits:
          #   cpu: "250m"
          #   memory: "512Mi"
        env:
        - name: COMPlus_ThreadPool_ForceMinWorkerThreads
          value: "100"
        - name: COMPlus_gcServer
          value: "1"
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: sentry-secrets
              key: SENTRY_DSN
        - name: SENTRY_ENVIRONMENT
          value: "development"
        - name: SENTRY_RELEASE
          value: "pfh-kubernetes@v3.0.0"
        - name: SENTRY_SERVER_NAME
          value: "ge-service-4"

        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: REDIS_HOST_OVERRIDE
          value: "redis:6379"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 15
          failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 15
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /app/Internal
          readOnly: true
      volumes:
      - name: ge-service-config-volume
        persistentVolumeClaim:
          claimName: ge-pvc
---
# -------- GEService 5 --------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ge-service-5
  namespace: ge-dev
  labels:
    app: ge-service
    shard: "5"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ge-service
      shard: "5"
  template:
    metadata:
      labels:
        app: ge-service
        shard: "5"
    spec:
      nodeSelector:          
        agentpool: geserver  
      imagePullSecrets:
      - name: ghcr-pull-secret
      initContainers:
      - name: wait-for-config
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for /mnt to be ready..."
            while [ -z "$(ls -A /mnt 2>/dev/null)" ]; do
              sleep 2
            done
            echo "Config found. Starting service."
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /mnt
      containers:
      - name: ge-service-container
        image: ghcr.io/rajp1011/pfhbe/geservice:v3.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: "150m"
            memory: "256Mi"
          # limits:
          #   cpu: "250m"
          #   memory: "512Mi"
        env:
        - name: COMPlus_ThreadPool_ForceMinWorkerThreads
          value: "100"
        - name: COMPlus_gcServer
          value: "1"
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: sentry-secrets
              key: SENTRY_DSN
        - name: SENTRY_ENVIRONMENT
          value: "development"
        - name: SENTRY_RELEASE
          value: "pfh-kubernetes@v3.0.0"
        - name: SENTRY_SERVER_NAME
          value: "ge-service-5"

        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: REDIS_HOST_OVERRIDE
          value: "redis:6379"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 15
          failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 15
        volumeMounts:
        - name: ge-service-config-volume
          mountPath: /app/Internal
          readOnly: true
      volumes:
      - name: ge-service-config-volume
        persistentVolumeClaim:
          claimName: ge-pvc